/*!
 * @namespace usocket
 * @description gerencia conexão e mensagens do serviço WebSocket UOL
 * @version 2.8.8
 * @author uolconteudo-projetos
 */
;!function(e){"object"!=typeof e.usocket&&(e.usocket=function(e,n){function t(n){function t(e){var n=e.match(/id=([^&]+)$/);return null!==n&&(b.channels.push(n[1]),b.url=e.replace("wss:","https:").replace(/\?.*/,""),!0);}function o(){return g>=b.channels.length&&(g=0),b.channels[g++];}function r(e,n){return !n||"function"==typeof n&&!0===n.call(b)?(clearTimeout(l),l=setTimeout(i,e)):C.close(!1),!0;}function i(n){var t;if(n?t=n:(C.channel=o(),t=C.channel),0===b.channels.length){return e(C).triggerHandler("close",{code:h});}e.ajax({type:"GET",url:b.url+"?id="+t+"&ifmod="+(b.channelsUpdated[t]||0)+"&ts="+ +new Date,cache:!0,dataType:"script",timeout:u,success:function(){},error:function(){e(C).triggerHandler("error",{code:f});}});}var a,s=1,l=0,g=0,b={url:n,channels:[],channelsUpdated:{},openDelay:100},C={URL:n,CONNECTING:0,OPEN:s,CLOSING:2,CLOSED:3,isFake:!0,removeChannels:function(n){if(n){b.channels=e.grep(b.channels,function(e){return e!==n;}),delete b.channelsUpdated[n],delete v[n];}else{for(var t;t=b.channels.pop();){delete b.channelsUpdated[t],delete v[t];}}},channel:"",setLastModified:function(e){b.channelsUpdated[this.channel]=e;},readyState:0,reconnect:r,send:function(e){var n=e.match(/^unsubscribe:(.+)/);n?c.onmessage('{"unsubscribed":"'+n[1]+'"}'):b.channels.push(e);},close:function(n){this.readyState=2,clearTimeout(a),clearTimeout(l),this.readyState=3,!1!==n?e(C).triggerHandler("close",{code:d}):m=null;},onopen:function(){},onmessage:function(){},onerror:function(){},onclose:function(){}};return function(){var o=t(n);return a=setTimeout(function(){!0===o?(C.readyState=s,e(C).triggerHandler("open"),b.channels.length&&i()):e(C).triggerHandler("close",{code:p});},b.openDelay),C;}();}var o=function(){},r=navigator.userAgent,i=void 0!==n.WebSocket&&3===n.WebSocket.CLOSED;!0===/Android (4.[0123]|2.\d)/.test(r)&&!1===/ Chrome\//.test(r)&&(i=!1);var c={},a="rtw.uol.com",s=!1,l=1000,u=10000,f=1006,d=1000,h=4001,p=4002,v={},g=[],m=null,b=null,C=+new Date,k=null,y=function(n){return e.map(n,function(e){return[e];});},N=function(){m&&!0!==m.isFake&&(c.send(""),C=+new Date);},O=function(){if(+new Date-C>=240000&&N(),!1===c.isConnected()&&m){return m.onerror({code:"TIMEOUT"}),!1;}b=setTimeout(O,30000);},S=function(){clearTimeout(b);},w=function(e,n,t){var o=[];t?v[t]&&o.push(v[t]):o=o.concat(y(v));for(var r=0,i=o.length;r<i;r++){void 0!==o[r]&&"function"==typeof o[r].pub&&o[r].pub(e,n);}},L=function(e){if(null!==m){var n=[];if(e){if(v[e]&&n.push(v[e]),!0===m.isFake){return m.removeChannels(e),!0;}}else{n=n.concat(y(v));}for(var t=0,o=n.length;t<o;t++){n[t].off(),delete v[n[t].channelName];}}},D=function(){L(),S(),m&&(m.onmessage=null,m.onclose=null,m.onerror=null,m=null);},T=function(e){e=e||"",null===m||4===m.readyState?(m=!0===i&&!1===s?new WebSocket("wss://"+a+"/sub?id="+e):new t("wss://"+a+"/sub?id="+e),m.reconnect||(m.reconnect=o),m.onopen=function(e){U(),O(),w("open",e);},m.onmessage=c.onmessage,m.onerror=function(e){w("error",e),e.invalidChannel||D();},m.onclose=function(e,n){var t=e&&e.code||n&&n.code||0;t===f||1001===t?w("error",e):!1!==e.triggerClose&&w("close",e),D();}):!0===c.isConnected()?m.send(e):U(e);},U=function(e){if("string"==typeof e){g.push(e);}else{for(var n;n=g.shift();){m.send(n);}}},W=function(e){if(v[e]){return v[e];}if(this instanceof W==!1){return new W(e);}var n={message:[],close:[],error:[],lost:[],open:[]};this.channelName=e;var t={};return this.data=function(e){return void 0===e?t:t=e;},this.on=function(e,t){if(n[e]){var o;for(o in n[e]){if(!0===n[e].hasOwnProperty(o)&&n[e][o]===t){return this;}}n[e].push(t);}return this;},this.off=function(e,t){var o,r;if(e){var i=n[e];if(i){for(o=0,r=i.length;o<r;o++){(t&&i[o]===t||!t)&&(i[o]=null);}}}else{for(o in n){if(!0===n.hasOwnProperty(o)){for(;n[o].pop();){}}}}return this;},this.close=function(){return !0===c.isConnected()&&(this.client_solicitation=!0,m.send("unsubscribe:"+e)),this;},this.pub=function(e,t){for(var o=n[e],r=0,i=o.length;r<i;r++){o[r].call(this,t);}},T(e),this;};return c.version="2.8.8",c.CONFIG_CHANGES="CONFIG_CHANGES",c.connect=function(e){return v[e]=new W(e),v[e];},c.disconnect=function(e){return m&&m.close(1000,e||"NORMAL"),c;},c.isConnected=function(){return !(!m||m.readyState!==m.OPEN);},c.send=function(e){return !0===this.isConnected()&&m.send(e),this;},c.lastMessageTime=function(){return new Date(C);},c.onmessage=function(e){if(!e){return m.reconnect(l);}if(!1===c.isConnected()){return !1;}var n=m.isFake?e:e.data;if(void 0===n){return m.reconnect(l);}try{"object"!=typeof n&&(n=JSON.parse(n));}catch(e){return m.reconnect(10000),w("error",{error:"INVALID_JSON"}),console.error("mensagem precisa ser um JSON válido",n);}if(n.invalidChannel){return w("error",n,n.invalidChannel),L(n.invalidChannel),m&&!0===m.isFake&&m.reconnect(l,function(){return this.channels.length>0;}),console.log("invalidChannel: ",n.invalidChannel);}if(n.unsubscribed){return w("close",n,n.unsubscribed),L(n.unsubscribed),m.reconnect(200);}if(!n.channelName){return m.reconnect(10000),w("error",{error:"NO_CHANNEL_NAME"}),console.error('json precisa do atributo "channelName"',n);}if(!n.lastModified){return m.reconnect(10000),w("error",{error:"NO_LAST_MODIFIED"}),console.error('json precisa do atributo "lastModified"',n);}if(void 0===v[n.channelName]){return !1;}var t=v[n.channelName].data().lastModified;void 0!==t&&n.prevModified!==t&&w("lost",{error:"LOST_DATA"}),v[n.channelName].data(n),C=+new Date,w("message",n,n.channelName),!0===m.isFake&&(m.setLastModified(n.lastModified),m.reconnect(200));},c.config=function(e){var n={domain:a,forcePolling:s,pollingDelay:l,channels:v,connection:m};if(void 0===e){return n;}if("string"==typeof e){return n[e];}if(!0===e.parasite&&null!==k){return !1;}if(!0===c.isConnected()){return console.log("usocket.confg()\tAs configurações só são aplicadas quando não há conexão estabelecida."),!1;}k=e;var t;for(t in e){if(!0===e.hasOwnProperty(t)){var o=e[t];switch(t){case"domain":a=o;break;case"forcePolling":s=o;break;case"pollingDelay":l=o;}}}return !0;},c.polling=function(n,t,r,i){if(void 0!==v[n]&&void 0===i){return console.error("Não é possível fazer polling em canal com conexão WebSocket ativa.");}t=t||o;var c=function(e){if(e.channelName===n||e.invalidChannel===n){t.apply(r,[e.hasOwnProperty("invalidChannel"),e]);for(var o=0,i=UOLWebSocketCollection.length;o<i;o++){UOLWebSocketCollection[o]===c&&(UOLWebSocketCollection.splice(o,1),c=null);}}};UOLWebSocketCollection.push(c),e.ajax({url:"https://"+a+"/sub?id="+n+"&ifmod=0&ts="+ +new Date,cache:!0,dataType:"script",scriptCharset:"utf-8"});},(n.UOLWebSocketCollection=n.UOLWebSocketCollection||[]).push(c.onmessage),"function"!=typeof n.UOLWebSocketCallback&&(n.UOLWebSocketCallback=function(e){for(var t=n.UOLWebSocketCollection,o=0;o<t.length;o++){t[o].call(null,e);}}),c;}(jQuery,e)),"function"==typeof define&&define.amd&&define("usocket",[],function(){return usocket;}),"undefined"!=typeof angular&&angular.module("usocket",[]).factory("usocket",[function(){return usocket;}]);}(window);