(function($){var Cotacoes=window.Cotacoes={};Cotacoes.DEFAULT_TIMEOFFSET=-10800000;Cotacoes.SERVICES={STOCK:"//cotacoes.economia.uol.com.br/ws/asset/",CURRENCY:"//cotacoes.economia.uol.com.br/cambioJSONChart.html"};Cotacoes.setGlobal=function(options){if(Highcharts){Highcharts.setOptions({"lang":{"decimalPoint":",","months":["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],"shortMonths":["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"]},"global":options});}};Cotacoes.Grafico=function(id,config){Cotacoes.setGlobal({"useUTC":false});this.id=id;this.config=config;this.getData(false);Cotacoes.sugest();Cotacoes.iPad();};Cotacoes.Grafico.prototype.getData=function(isRedraw){var _this=this,_params=this.getConfig().finance;delete _params.data.replicate;var _type=this.getType(_params.type),_url=this.getRequestURL(_params,_type);this.isRedraw=isRedraw;$.ajax({dataType:"jsonp",url:_url,data:_params.data,jsonpCallback:_this.id+".parseData",cache:true});};Cotacoes.Grafico.prototype.parseData=function(finance){if(finance.error){this.error(finance.error||"");return;}var _series=_item=[],_config=this.getConfig(),_data=(this.isCurrency()?finance[1]:finance.data),_timeOffset=finance.timeOffSet||Cotacoes.DEFAULT_TIMEOFFSET;_total=_data.length,_boundaries={};_data_new=[];_cnt=0;this.setDate(finance.today);if(!this.isCurrency()){if(_config.grafico.type=="area"){while(_total--){_series.push([Cotacoes.toGMT(_data[_total].date,_timeOffset),_data[_total].price]);}}else{while(_total--){_series.push([Cotacoes.toGMT(_data[_total].date,_timeOffset),_data[_total].open,_data[_total].high,_data[_total].low,_data[_total].price]);}}}else{for(var k=0;k<_data.length;k++){if(_data[k]["ask"]!=-1){_series.push([Cotacoes.toGMT(_data[k]["ts"],_timeOffset),_data[k]["ask"]]);_data_new[_cnt]=_data[k];_cnt++;}}}if(!this.isCurrency()){_boundaries=this.getMinMax(_data[!this.isCurrency()?(_data.length-1):0][!this.isCurrency()?"date":"ts"],_timeOffset,_config.finance.type,_config.finance.id);}else{_boundaries=this.getMinMax(_data_new[!this.isCurrency()?(_data_new.length-1):0][!this.isCurrency()?"date":"ts"],_timeOffset,_config.finance.type,_config.finance.id);}if(_config.grafico.size=="LARGE"&&!this.isRedraw){if(!this.isCurrency()){Cotacoes.Table.stock(finance,this.id,_config.grafico.container);}else{Cotacoes.Table.currency(finance,this.id,_config.grafico.container);}}this.build(_series,_boundaries);};Cotacoes.Grafico.prototype.build=function(series,boundaries){var _this=this,_config=$.extend({},this.PRESET["DEFAULT"],this.PRESET[this.getConfig().grafico.size]),_type=this.getConfig().finance.type,_grafico=this.getConfig().grafico.type;_config.chart.renderTo=this.getConfig().grafico.container;if(this.getConfig().grafico.size=="LARGE"){_config.chart.type=this.getConfig().grafico.type.toLowerCase();}if(this.isCurrency()&&this.config.finance.data.type=="range"){_config.xAxis.min=null;_config.xAxis.max=null;}else{_config.xAxis.min=boundaries.min;_config.xAxis.max=boundaries.max;}_config.xAxis.tickInterval=Cotacoes.tickInterval(_type);if(!_config.xAxis.labels){_config.xAxis.labels={};}if(!_config.tooltip){_config.tooltip={};}_config.xAxis.labels.formatter=function(){return Cotacoes.formatter(this.value,_type,boundaries);};_config.tooltip.formatter=function(){return Cotacoes.tooltip(this,_type,_grafico,_this.isCurrency());};_config.series=[{"data":series,"name":this.getConfig().finance.ticker,"threshold":null}];if(this.isRedraw){this.chart.destroy();}this.chart=new Highcharts.StockChart(_config);if(!this.isRedraw&&this.getConfig().grafico.size=="LARGE"){Cotacoes.Filter.build(this.id,this.getConfig().grafico.container,this.isCurrency());}};Cotacoes.Grafico.prototype.getMinMax=function(firstDate,timeOffset,type){var _gmt=((timeOffset/1000)/60)/60,_min=new Date(firstDate),_hmin,_max,_utc;if(type=="1d"){_hmin=_min.getUTCHours();_min.setHours(_hmin+_gmt);if(_min.getHours()<9){_min.setHours(9);}_min.setMinutes(0);_min.setSeconds(0);_max=new Date(_min.valueOf());_max.setHours(_max.getHours()+8);if(!this.isCurrency()){_max.setMinutes(0);}var closingHour=17;if(_max.getHours()>closingHour){_max.setHours(closingHour);}_min=_min.valueOf();_max=_max.valueOf();}else{if(!this.isCurrency()){_min=this.config.finance.data.begin;_max=this.config.finance.data.end;}else{if(this.config.finance.data.type=="range"){_min=this.config.finance.data.begin.split("/");_min=new Date(_min[1]+"/"+_min[0]+"/"+_min[2]).valueOf();_max=this.config.finance.data.end.split("/");_max=new Date(_max[1]+"/"+_max[0]+"/"+_max[2]).valueOf();}else{this.config.finance.data.type=type.substring(1,2);}}}return{min:_min,max:_max};};Cotacoes.Grafico.prototype.redraw=function(chart,type,button,range){var _financeType=this.getConfig().finance.type,_chartType=this.getConfig().grafico.type;if(((type=="ohlc"||type=="candlestick")&&_financeType=="1d")||(type=="1d"&&(_chartType=="ohlc"||_chartType=="candlestick"))){alert("OHLC e Candlestick não estão disponíveis para o período de 1 dia");return;}if(button!=null){button.parents("ul").find(".ativo").removeClass("ativo bgcolor1");button.addClass("ativo bgcolor1");}this.setType(chart,type,range);this.getData(true);};Cotacoes.Grafico.prototype.getConfig=function(){return this.config;};Cotacoes.Grafico.prototype.getType=function(type){return type=="1d"?"intraday":"interday";};Cotacoes.Grafico.prototype.setType=function(chart,type,range){var _date=new Date(this.getDate()),_span;this.config[chart=="timeFilter"||chart=="rangeFilter"?"finance":"grafico"].type=type;if(chart=="timeFilter"){if(type=="1s"){_span=8;}if(type=="1m"){_span=30;}if(type=="3m"){_span=90;}if(type=="1a"){_span=365;}if(type!="1d"){_date.setDate(_date.getDate()-1);_date.setHours(0);_date.setMinutes(0);_date.setSeconds(1);if(!this.isCurrency()){this.setParam("end",_date.valueOf());this.setParam("begin",_date.setDate(_date.getDate()-_span));}}else{this.removeParam("end");this.removeParam("begin");}if(type!="3m"){type=type.substring(1,2);}else{type="tm";}this.setParam("type",type);}else{if(chart=="rangeFilter"){this.setParam("end",range.end);this.setParam("begin",range.begin);if(this.isCurrency()){this.setParam("type","range");}}}};Cotacoes.Grafico.prototype.setParam=function(param,value){this.config.finance.data[param]=value;};Cotacoes.Grafico.prototype.removeParam=function(param){if(this.config.finance.data[param]){try{delete this.config.finance.data[param];}catch(e){}}};Cotacoes.Grafico.prototype.getDate=function(){return this.getConfig().finance.today;};Cotacoes.Grafico.prototype.setDate=function(date){this.getConfig().finance.today=date;};Cotacoes.Grafico.prototype.getRequestURL=function(params,type){var _url=Cotacoes.SERVICES[this.isCurrency()?"CURRENCY":"STOCK"];if(!this.isCurrency()){_url+=params.id+"/"+type;}return _url;};Cotacoes.Grafico.prototype.isCurrency=function(){return(this.getConfig().finance.id==0);};Cotacoes.Grafico.prototype.error=function(error){var _container=jQuery("#"+this.getConfig().grafico.container),_mensagem='<p class="erro-grafico">';switch(error){case"FSW-0401":_mensagem+="Não há registros para essa ação.";break;default:_mensagem+="Gráfico indisponível no momento.";}_mensagem+="</p>";_container.html(_mensagem);};Cotacoes.Grafico.prototype.PRESET={DEFAULT:{"chart":{"renderTo":"container","type":"area"},"credits":{"enabled":false},"exporting":{"enabled":false},"labels":{"style":{"color":"#ccc"}},"rangeSelector":{"enabled":false},"scrollbar":{"enabled":false},"navigator":{"enabled":false},"plotOptions":{"area":{"lineColor":"#333","lineWidth":1,"color":"#9bb8b1"},"candlestick":{"gapSize":0,"color":"#9bb8b1"},"ohlc":{"color":"#9bb8b1"},"series":{"marker":{"fillColor":"#fe9900"},"states":{"hover":{"lineWidth":1}},"dataGrouping":{"enabled":false}}},"yAxis":{"offset":50,"labels":{"y":3},"showLastLabel":true,"opposite":true},"title":{"text":null},"series":[]},LARGE:{"xAxis":{"alternateGridColor":"#F6F6F6","ordinal":false,"showEmpty":false,"endOnTick":false,"labels":{"y":17,"enabled":true},"maxPadding":0.02,"minPadding":0.02}}};Cotacoes.tickInterval=function(type){var seconds=3600*1000,ticks={"1d":{tickInterval:seconds},"1s":{tickInterval:seconds*24},"1m":{tickInterval:seconds*24*5},"3m":{tickInterval:seconds*24*30},"1a":{tickInterval:seconds*24*30},"range":{tickInterval:null}};return ticks[type].tickInterval;};Cotacoes.tooltip=function(item,time,chart,isCurrency){var tooltip="";if(time=="1d"){tooltip+="Hora: "+Highcharts.dateFormat("%H:%M",item.points[0].x);}else{tooltip+="Data: "+Highcharts.dateFormat("%d/%m/%Y",item.points[0].x);}if(chart=="area"){if(isCurrency){tooltip+="<br>"+"Valor: "+Highcharts.numberFormat(item.points[0].y,4,",",".");}else{tooltip+="<br>"+"Pontos: "+Highcharts.numberFormat(item.points[0].y,2,",",".");}}else{tooltip+="<br>Abertura: "+Highcharts.numberFormat(item.points[0].point.open,2,",",".");tooltip+="<br>Mínima: "+Highcharts.numberFormat(item.points[0].point.low,2,",",".");tooltip+="<br>Máxima: "+Highcharts.numberFormat(item.points[0].point.high,2,",",".");tooltip+="<br>Fechamento: "+Highcharts.numberFormat(item.points[0].point.close,2,",",".");}return tooltip;};Cotacoes.formatter=function(date,type,boundaries){var formatos={"1d":Highcharts.dateFormat("%Hh",date),"1s":Highcharts.dateFormat("%d/%m",date),"1m":Highcharts.dateFormat("%d/%m",date),"3m":Highcharts.dateFormat("%b",date),"1a":Highcharts.dateFormat("%b/%y",date),"range":Cotacoes.rangeFormat(date,boundaries)};return formatos[type];};Cotacoes.rangeFormat=function(date,boundaries){var _r;if(boundaries.max-boundaries.min<2600000000){_r=Highcharts.dateFormat("%d/%m",date);}else{if(boundaries.max-boundaries.min<7800000000){_r=Highcharts.dateFormat("%d/%b",date);}else{_r=Highcharts.dateFormat("%b/%Y",date);}}return _r;};Cotacoes.Filter={Markup:{RANGE_FILTER:'<div class="consulta">						<p>Per&iacute;odo a ser consultado:</p>						<span>de</span>						<input type="text" name="begin" class="input dp-applied dp-start" id="begin">						<span>a</span>						<input type="text" name="end" class="input dp-applied dp-end" id="end">						<input type="submit" name="a" value="Ok" class="botao3 bgcolor1" id="a">					</div>',TIME_FILTER:'<ul id="timeFilter" class="chartFilter atalhos">						<li class="periodo_d"><a href="#" class="h-bgcolor1 bgcolor1 ativo">1D</a></li>						<li class="periodo_s"><a href="#" class="h-bgcolor1">1S</a></li>						<li class="periodo_m"><a href="#" class="h-bgcolor1">1M</a></li>						<li class="periodo_tm"><a href="#" class="h-bgcolor1">3M</a></li>						<li class="periodo_a"><a href="#" class="h-bgcolor1">1A</a></li>					</ul>',CHART_TYPE:'<div class="tipos-grafico">						<strong>Visualize o gr&aacute;fico por:</strong>						<ul id="chartType" class="chartFilter">							<li><a href="#" class="h-bgcolor1 bgcolor1 ativo">Area</a></li>							<li><a href="#" class="h-bgcolor1">Candlestick</a></li>							<li><a href="#" class="h-bgcolor1">OHLC</a></li>						</ul>					</div>'},build:function(id,container,isCurrency){var html=this.Markup.RANGE_FILTER+(!isCurrency?this.Markup.CHART_TYPE+this.Markup.TIME_FILTER:this.Markup.TIME_FILTER);$(".periodo").append(html);this.bind(id,isCurrency);},bind:function(id,isCurrency){var _type,_begin,_end;$(".chartFilter a").on("click",function(ev){if($(this).hasClass("ativo")){return false;}_type=$(this).parents("ul").attr("id");window[id].redraw(_type,$(this).text().toLowerCase(),$(this));ev.preventDefault();});$("#begin, #end").datepick({maxDate:0});$(".periodo :submit").on("click",function(evt){if($("#begin").val()==""||$("#end").val()==""){alert("Para consultar selecione a data de início e fim.");return;}_begin=jQuery("#begin").val().split("/");_begin=new Date(_begin[1]+"/"+_begin[0]+"/"+_begin[2]).valueOf();_end=jQuery("#end").val().split("/");_end=new Date(_end[1]+"/"+_end[0]+"/"+_end[2]).valueOf();if(_begin>_end){alert("A data final deve ser maior que a inicial.");return;}$("#timeFilter a").removeClass("ativo bgcolor1");if(isCurrency){_begin=jQuery("#begin").val();_end=jQuery("#end").val();}window[id].redraw("rangeFilter","range",null,{"begin":_begin,"end":_end});evt.preventDefault();});}};Cotacoes.Table={Markup:{STOCK:'<strong><span>&Uacute;ltima negocia&ccedil;&atilde;o registrada:</span> </strong>				<table>					<thead>						<tr>							<th></th>							<th>Hor&aacute;rio</th>							<th>Cota&ccedil;&atilde;o</th>							<th>Varia&ccedil;&atilde;o</th>							<th>% Varia&ccedil;&atilde;o</th>							<th>M&iacute;nimo</th>							<th>M&aacute;ximo</th>							<th>Volume</th>						</tr>					</thead>					<tbody>						<tr>							<th><span class="tick"></span></th>							<td class="date"></td>							<td class="price"></td>							<td class="var"></td>							<td class="varpct"></td>							<td class="low"></td>							<td class="high"></td>							<td class="vol"></td>						</tr>					</tbody>				</table>',CURRENCY:'<strong><span>&Uacute;ltima negocia&ccedil;&atilde;o registrada:</span> </strong>				<table>					<thead>						<tr>							<th></th>							<th>Hor&aacute;rio</th>							<th>Compra</th>							<th>Venda</th>							<th>% Varia&ccedil;&atilde;o</th>							<th>Varia&ccedil;&atilde;o</th>							<th>M&aacute;ximo</th>							<th>M&iacute;nimo</th>						</tr>					</thead>					<tbody>						<tr>							<th><span class="tick"></span></th>							<td class="date"></td>							<td class="bid"></td>							<td class="ask"></td>							<td class="pctChange ultima"></td>							<td class="varBid ultima"></td>							<td class="high"></td>							<td class="low"></td>						</tr>					</tbody>				</table>'},stock:function(finance,id,container){var _table=$(".infoTable"),_info={lastUpdate:Highcharts.dateFormat("%H:%M - %d/%m/%Y",finance.lastUpdate),tick:finance.data[0].varpct<0?"baixa":"alta",date:Highcharts.dateFormat("%H:%M",finance.data[0].date),price:Highcharts.numberFormat(finance.data[0].price,2,",","."),_var:Highcharts.numberFormat(finance.data[0]["var"],2,",","."),varpct:Highcharts.numberFormat(finance.data[0].varpct,2,",","."),low:Highcharts.numberFormat(finance.data[0].low,2,",","."),high:Highcharts.numberFormat(finance.data[0].high,2,",","."),vol:Highcharts.numberFormat(finance.data[0].vol,0,"",".")};_table.html(this.Markup.STOCK);_table.find("tbody tr").addClass(_info.tick);_table.find("strong span").after(_info.lastUpdate);_table.find(".tick").html(_info.tick);_table.find(".date").html(_info.date);_table.find(".price").html(_info.price);_table.find(".var").html(_info._var);_table.find(".varpct").html(_info.varpct);_table.find(".low").html(_info.low);_table.find(".high").html(_info.high);_table.find(".vol").html(_info.vol);},currency:function(finance,id,container){var _table=$(".infoTable"),_info={tick:parseFloat(finance[2].pctChange)<0?"baixa":"alta",date:Highcharts.dateFormat("%H:%M",finance[2].timestamp),ask:Highcharts.numberFormat(finance[2].ask,4,",","."),bid:Highcharts.numberFormat(finance[2].bid,4,",","."),pctChange:Highcharts.numberFormat(finance[2].pctChange,4,",","."),varBid:Highcharts.numberFormat(finance[2].varBid,4,",","."),high:Highcharts.numberFormat(finance[2].high,4,",","."),low:Highcharts.numberFormat(finance[2].low,4,",",".")};_table.html(this.Markup.CURRENCY);_table.find("tbody tr").addClass(_info.tick);_table.find("strong span").after(_info.date);_table.find(".date").html(_info.date);_table.find(".ask").html(_info.ask);_table.find(".bid").html(_info.bid);_table.find(".pctChange").html(_info.pctChange);_table.find(".varBid").html(_info.varBid);_table.find(".high").html(_info.high);_table.find(".low").html(_info.low);}};Cotacoes.toGMT=function(date,timeOffset){var _GMT=((timeOffset/1000)/60)/60,_fixedHour=new Date(date),_UTCHours=_fixedHour.getUTCHours();_fixedHour.setHours(_UTCHours+_GMT);return _fixedHour.valueOf();};Cotacoes.iPad=function(){var _iPad=navigator.userAgent.indexOf("iPad");if(_iPad>0){$("body").addClass("ipad");}};Cotacoes.sugest=function(){if(jQuery("#economia-busca-acao input[name=busca]").length>0){var _campo=jQuery("#economia-busca-acao input[name=busca]"),_busca=new autoComplete($("#economia-busca-acao input[name=busca]"),$(".buscaAcoes form"));if(location.href.indexOf("/dev/")>-1){_busca.url="http://economia.uol.com.br/cotacoes/bolsas/dev/acoes/bvsp-bovespa/";}else{_busca.url="http://economia.uol.com.br/cotacoes/bolsas/acoes/bvsp-bovespa/";}_campo.bind("blur",_busca,_busca.hideBlur);_campo.bind("keyup keydown",_busca,_busca.kupdn);$(":submit",_campo[0].form).bind("click",_busca,_busca.formSubmit);if(jQuery.browser.opera){_campo.bind("keypress",function(evt){if(evt.keyCode==13){voidDefault(evt);}});}}};})(jQuery);